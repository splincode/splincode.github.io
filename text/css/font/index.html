<!DOCTYPE html>
<html>
<head>
	<title>FontFaceObserver</title>
	<meta charset='utf-8'>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/main.css">
	<script src='js/fontfaceobserver.js'></script>
	<script src='js/fontconfig.js'></script>
</head>
<body>

	<section class="center">
		<p class='f50'>WebFonts и FontFaceObserver</p>
		<p class='f50'>подгрузка шрифтов </p>

		<section class="usefont">
			<p class='f25'>WebFonts. История</p>
			<p><span class='view'>WebFonts</span> - это технология использования сторонних шрифтов на своей веб-странице, один из примеров:</p>
			<img src='http://upload.wikimedia.org/wikipedia/commons/a/a7/Web_fonts.png'>
			<p>Если начинать с истоков, тег <span class='view'>font</span> был введен в 1995 году, а уже в 1996 было написано программное определение на CSS. Начиная с версии CSS 2.0 была введена загрузка и синтез шрифта в браузерах, но тем не менее еще тогда популярный, а сейчас уже старый и не актуальный IE не имел поддержки загрузки шрифтов, что мешало бурной моде нововведения, использования шрифтов на своем сайте.</p>

			<p>
				Теперь уже веб-шрифты в современном интернете это давно устоявшаяся вещь, на разных сайтах мы можем использовать разного рода шрифты, которые в свою очередь не включены в поставку той или иной операционной системы, однако есть нежелательный побочный эффект, о чем мы сегодня и поговорим.
			</p>

			<p class='f25'>Форматы файлов</p>
			<p>
			Для подключения шрифтов используется программная вставка в CSS, так называемые <span class='view'>@-правило</span>. И так, в простейшей форме <span class='view'>@font-face</span> это эдакая декларация, выглядит она следующим образом:
			</p>

<div class="highlight">
<pre><div id="lc1"><span class="c">/* Объявляем шрифт */</span>
</div><div id="lc2"><span class="k">@font-face</span> <span class="p">{</span>
</div><div id="lc3">  <span class="nt">font-family</span><span class="o">:</span> <span class="s1">&#39;Имя шрифта&#39;</span><span class="o">;</span>
</div><div id="lc4">  <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;путь/до/него&#39;</span><span class="o">);</span>
</div><div id="lc5"><span class="p">}</span>
</div><div id="lc6">
</div><div id="lc7"><span class="c">/* Применяем шрифт */</span>
</div><div id="lc8"><span class="nt">p</span> <span class="p">{</span>
</div><div id="lc9">  <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;Имя шрифта&#39;</span><span class="o">,</span> <span class="n">Arial</span><span class="p">;</span>
</div><div id="lc10"><span class="p">}</span>
</div></pre></div>

		<p><span class="view">TTF</span> или <span class="view">OTF</span> — привычный нам файл шрифта, но подгружаемый с сервера на время просмотра сайта;</p>
		<p><span class="view">WOFF</span> — незащищенный архив исходника OTF или TTF, пожалуй, самый важный формат, который поддерживают большинство популярных браузеров, а файлы в WOFF обычно 2–2,5 раза легче, чем исходные;</p>
		<p><span class="view">EOT</span> — внедряемый TT OpenType архив, имеющий механизмы защиты, нужен для поддержки старых браузеров Internet Explorer (начиная с IE8 кроме TrueType кривых, поддерживаются и PostScript);</p>
		<p><span class="view">SVG</span> — для поддержки браузера Safari.</p>

<div class="highlight mtop"><pre><div id="lc1"><span class="k">@font-face</span> <span class="p">{</span>
</div><div id="lc2"> <span class="nt">font-family</span><span class="o">:</span> <span class="s1">&#39;Имя_шрифта_любое&#39;</span><span class="o">;</span>
</div><div id="lc3"> <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.eot&#39;</span><span class="o">);</span>
</div><div id="lc4"> <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.eot?#iefix&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;embedded-opentype&#39;</span><span class="o">),</span>
</div><div id="lc5"> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.woff&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;woff&#39;</span><span class="o">),</span>
</div><div id="lc6"> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.ttf&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;truetype&#39;</span><span class="o">),</span>
</div><div id="lc7"> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.svg#DSNoteRegular&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;svg&#39;</span><span class="o">);</span>
</div><div id="lc8"> <span class="nt">font-weight</span><span class="o">:</span> <span class="nt">normal</span><span class="o">;</span>
</div><div id="lc9"> <span class="nt">font-style</span><span class="o">:</span> <span class="nt">normal</span><span class="o">;</span>
</div><div id="lc10"><span class="p">}</span>
</div></pre></div>

	<p>
		Подготовленные к внедрению (@font-face) на сайт шрифты на сегодняшний день должны быть сразу в нескольких форматах. Вы поняли, что существуют некоторые расхождения, так же как существует не один вид операционных систем. Форматов шрифтов достаточно много, но конкретный будет работать только в конкретном браузере, вот такая вот судьба. Что же касается этих самых форматов, отчего их так много нужно указывать при подключении, то вот, пожалуйста, они нужны для кроссбраузерной поддержки сайта.
	</p>
		<br>
	<p>
		Ежели вы хотите использовать вместо файла зашифрованный код, в этом случае к нам на помощь приходит base64, который работает по тому же принципу и с изображениями, однако для старого IE base64 не обрабатывается.
	</p>

<div class="highlight"><pre><div id="lc1"><span class="k">@font-face</span> <span class="p">{</span>
</div><div id="lc2"> <span class="nt">font-family</span><span class="o">:</span> <span class="s1">&#39;Имя_шрифта_любое&#39;</span><span class="o">;</span>
</div><div id="lc3"> <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.eot&#39;</span><span class="o">);</span>
</div><div id="lc4"><span class="p">}</span>
</div><div id="lc5">
</div><div id="lc6"><span class="k">@font-face</span> <span class="p">{</span>
</div><div id="lc7"> <span class="nt">font-family</span><span class="o">:</span> <span class="s1">&#39;Имя_шрифта_любое&#39;</span><span class="o">;</span>
</div><div id="lc8"> <span class="nt">src</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="nt">data</span><span class="nd">:font</span><span class="o">/</span><span class="nt">woff</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">utf-8</span><span class="o">;</span><span class="nt">base64</span><span class="o">,</span><span class="err">ДАННЫЕ</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;woff&#39;</span><span class="o">),</span>
</div><div id="lc9"> <span class="nt">url</span><span class="o">(</span><span class="nt">data</span><span class="nd">:font</span><span class="o">/</span><span class="nt">truetype</span><span class="o">;</span><span class="nt">charset</span><span class="o">=</span><span class="nt">utf-8</span><span class="o">;</span><span class="nt">base64</span><span class="o">,</span><span class="err">ДАННЫЕ</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;truetype&#39;</span><span class="o">),</span>
</div><div id="lc10"> <span class="nt">url</span><span class="o">(</span><span class="s1">&#39;Имя_файла_шрифта.svg#Имя_файла_шрифта&#39;</span><span class="o">)</span> <span class="nt">format</span><span class="o">(</span><span class="s1">&#39;svg&#39;</span><span class="o">);</span>
</div><div id="lc11"> <span class="nt">font-weight</span><span class="o">:</span> <span class="nt">normal</span><span class="o">;</span>
</div><div id="lc12"> <span class="nt">font-style</span><span class="o">:</span> <span class="nt">normal</span><span class="o">;</span>
</div><div id="lc13"><span class="p">}</span>
</div></pre></div>
		<span class="clear"></span>

		<p class='f25'>Embedded OpenType?</p>
		<p>Если вы могли заметить, то подключаемые шрифты для IE имеют строчку с таким параметром:</p>
		<p><span class="view">src: url('Имя_файла_шрифта.eot?#iefix') format('embedded-opentype')</span></p>
		<p>В классике, мы должны были указать с вами именно так:</p>
		<p><span class="view">src: url('Имя_файла_шрифта.eot') format('embedded-opentype')</span></p>
		<p>но при добавлении символа "?" после формата шрифта, мы принудительно указываем браузеру не читать последующее указание - format('embedded-opentype'). Internet Explorer поддерживает вложение шрифтов через так называемый фирменный Embedded OpenType стандарт, начиная с версии IE 4.0. Он использует методом управления цифровыми правами для предотвращения копирования шрифтов, которые распространяются по лицензии.</p>

		<p class='f25'>Что если не поддерживается шрифт в браузере?</p>
		<p>Давным-давно уже были придуманы обходные пути, так называемые "костыли", для решения отображения того или иного шрифта. Бывают такие моменты, когда шрифт был разработан только в формате SVG, или же только в формате TTF.</p>

		<p>
			<span class="view">1.</span> В стародавние времена разработчики подключали изображение, которое в свою очередь было текстом набранным в визуальном редакторе. Однако сейчас это считается плохим тоном, ибо поддержка довольна затруднительна (нужно снова открывать редактор, чтобы изменить текст картинки) , соответственно, пользователь не может скопировать текст с картинки.
		</p>

		<p>
			<span class="view">2.</span> Также распространенным являлось использование flash-решений.
		</p>

		<p>
			<span class="view">3.</span> Другим решением является использование Javascript, чтобы заменить текст с VML (для Internet Explorer) или SVG (для всех остальных браузеров).
		</p>


		<p class='f25'>А какие проблемы еще могут возникнуть?</p>
		<p>Браузер будет пытаться синхронизировать подгрузку шрифта, он будет стараться спрятать текст, то есть сделать его невидимым, пока шрифт не был подгружен. Этот  эффект называют <span class="view">FOIT</span>, эффект "белой вспышки". </p>

		<p>Один из веб-разработчиков <span class="view">Bram Stein</span> опубликовал статью о том, как он исправил ситуацию, написав собственную реализацию полифила, в дальнейшем я опишу его реализацию и изложение проблемы.</p>

		<p class='f25'>Эффект вспышки</p>
		<p>Эффект FOIT в таких браузерах как Safari, Chrome, Opera, Firefox имеет тенденцию скрывать текст в течение максимум 30 секунд перед отказом в получении шрифта, после чего устанавливается шрифт по умолчанию.</p>

		<p>Пример того, как загружается шрифт:</p>
		<img src="img/1.png" width='100%'>
		<span class="clear"></span>

		<p>И все-таки, 3 секунды это долгое время!</p>
		<p class='f25'>Что же можно сделать?</p>
		<p>Изначальный подход заключался в том, чтобы включить <span class="view">преобразование файлов шрифта в</span> данные <span class="view">URIs</span> так, чтобы те шрифты могли быть включены непосредственно в определения семейства шрифтов в файле CSS. Загружая этот файл CSS асинхронным способом, можно гарантировать, что браузер немедленно отдаст текст в странице, используя кастомные шрифты, а новые шрифты применилась бы, как только CSS был бы загружен.</p>

		<p>Однако, как обычно, в любом эксперименте есть побочный эффект.</p>
		<p>Изначально <span class="view">Bram Stein</span> использовал кастомный шрифт, но после того как его шрифт был подгружен, происходило «мерцание», в примере на 0.7 секунде:</p>
		<img src="img/2.png" width='100%'>
		<span class="clear"></span>

		<p>Короче говоря, мерцание происходит тогда, когда браузер пытается отобразить шрифт из font-family и применить его в html. Шрифт, определенный в @font-face декларации, который не был еще загружен.</p>

		<p><span class="view">Bram Stein</span> показал как правильно подключать шрифты, он разработал скрипт, альтернатива скрипта от google для асинхронной подгрузки шрифтов, это скрипт -  <span class="view">FontFaceObserver</span>.</p>

		<p class='f25'>Пробуем</p>

		<iframe width="100%" height="490" src="https://www.youtube.com/embed/wUU9kQRJI5Q" frameborder="0" allowfullscreen></iframe>

		<p class='f25'>Анализ</p>
		<img src="img/3.png">
		<p><span class="view">Стандартное подключение от Google</span></p>
		<p>
			Честно говоря, используя больше одного шрифта на сайте можно конкретно замедлить скорость загрузки страницы сайта, тем самым
			увеличивая общее время загрузки. Google Fonts API позволяет быстро добавить шрифт на сайт, используя генератор шрифтов, тем самым быстрее проектировать свой сайт. Однако, нужно помнить об эффекте FOIT. Общее время загрузки: <span class="view">322 мс</span>
		</p><br><br>
		<span class="clear"></span>

		<img src="img/4.png">
		<p><span class="view">Web Font Loader от Google</span></p>
		<p>
			 Web Font Loader - JavaScript библиотека для расширенной работы с API, библиотека, которая дает нам больше контроля над подгрузкой шрифта, чем стандартный API Google Fonts. Скрипт позволяет нам использовать множество шрифтов, подгружая их последовательно. В отличие, от стандартного подключения, на слабых соединениях показывается текст со стандартным шрифтом, до тех пор пока не будет загружен шрифт. Общее время загрузки: <span class="view">1132 мс</span>
		</p>
		<br><br>
		<span class="clear"></span>

		<img src="img/5.png">
		<p><span class="view">FontFaceObserver</span></p>
		<p>
			FontFaceObserver - это JavaScript библиотека (5кб), так называемый подгрузчик совместимый с любым веб-обслуживанием шрифта. Скрипт позволяет уведомить нас о том, загрузился ли шрифт или нет, позволяет отслеживать событие после загрузки и до загрузки шрифта. Общее время загрузки: <span class="view">159 мс</span> <br><br>
			<a href='https://github.com/bramstein/fontfaceobserver' target='blank'>Документация (eng)</a><br>
			<br>
			<span class="view">Использование скрипта</span>
		</p>
		<span class="clear"></span>


<div class="highlight nf"><pre><div id="lc1"><span class="nt">&lt;style&gt;</span>
</div><div id="lc2"> <span class="k">@import</span> <span class="nt">url</span><span class="o">(</span><span class="nt">http</span><span class="o">://</span><span class="nt">fonts</span><span class="nc">.googleapis.com</span><span class="o">/</span><span class="nt">css</span><span class="o">?</span><span class="nt">family</span><span class="o">=</span><span class="err">НАЗВАНИЕ</span><span class="nt">_</span><span class="err">ШРИФТА</span><span class="o">&amp;</span><span class="nt">subset</span><span class="o">=</span><span class="nt">cyrillic</span><span class="o">,</span><span class="nt">latin</span><span class="o">)</span><span class="p">;</span>
</div><div id="lc3">
</div><div id="lc4"> <span class="c">/* шрифт по умолчанию, до тех пор пока не подгружен новый шрифт */</span>
</div><div id="lc5"> <span class="nt">body</span> <span class="p">{</span><span class="k">font-family</span><span class="o">:</span> <span class="k">sans-serif</span><span class="p">;}</span>
</div><div id="lc6"> <span class="c">/* новый шрифт */</span>
</div><div id="lc7"> <span class="nc">.fontOneLoad</span> <span class="nt">body</span> <span class="p">{</span>
</div><div id="lc8">    <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;НАЗВАНИЕ_ШРИФТА&#39;</span><span class="o">,</span> <span class="k">cursive</span><span class="p">;</span>
</div><div id="lc9"> <span class="p">}</span>
</div><div id="lc10"><span class="nt">&lt;/style&gt;</span>
</div><div id="lc11">
</div><div id="lc12"><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;js/fontfaceobserver.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</div><div id="lc13"><span class="nt">&lt;script&gt;</span>
</div><div id="lc14"> <span class="c1">// иницицилизация</span>
</div><div id="lc15"> <span class="kd">var</span> <span class="nx">fontOneLoad</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FontFaceObserver</span><span class="p">(</span><span class="s1">&#39;НАЗВАНИЕ_ШРИФТА&#39;</span><span class="p">,</span> <span class="p">{});</span>
</div><div id="lc16"> <span class="nx">fontOneLoad</span>
</div><div id="lc17">   <span class="p">.</span><span class="nx">check</span><span class="p">()</span>
</div><div id="lc18">   <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="c1">// событие, когда шрифт загружен</span>
</div><div id="lc19">      <span class="c1">// добавляем класс тегу html </span>
</div><div id="lc20">      <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">className</span> <span class="o">+=</span> <span class="s2">&quot; fontOneLoad&quot;</span><span class="p">;</span>
</div><div id="lc21">	<span class="p">});</span>
</div><div id="lc22"><span class="nt">&lt;/script&gt;</span>
</div></pre></div>


		<span class="clear"></span>
		</section>


	</section>




</body>
</html>
